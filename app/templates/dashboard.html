{% extends "base.html" %}

{% block title %}Dashboard - Salesforce Admin Learning Platform{% endblock %}

{% block content %}
<div class="container" x-data="dashboardData()">

    <!-- Header -->
    <div class="mb-4">
        <h1 class="page-title">Mi Progreso</h1>
        <p class="page-subtitle">Sigue tu avance en la certificación de Salesforce Admin</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card">
            <div
                style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-700); margin-bottom: 0.5rem;">
                Progreso Total</div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" x-text="overallProgress + '%'">0%
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" :style="{ width: overallProgress + '%' }"></div>
            </div>
        </div>
        <div class="card">
            <div
                style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-700); margin-bottom: 0.5rem;">
                Tareas Completadas</div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--gray-800);">
                <span x-text="completedTasks">0</span>
                <span style="color: var(--gray-300); font-size: 1.25rem;">/ <span x-text="totalTasks">0</span></span>
            </div>
        </div>
        <div class="card">
            <div
                style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-700); margin-bottom: 0.5rem;">
                Sprints Activos</div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--gray-800);">1</div>
        </div>
    </div>

    <!-- Sprints -->
    <template x-for="sprint in sprints" :key="sprint.id">
        <div class="card" style="margin-bottom: 2rem; padding: 0; overflow: hidden;">
            <div
                style="padding: 1.5rem; background: linear-gradient(to right, #f8f9fa, #ffffff); border-bottom: 1px solid var(--gray-200);">
                <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800);"
                    x-text="`Sprint ${sprint.number}: ${sprint.name}`"></h2>
                <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: 0.25rem;"
                    x-text="sprint.description"></div>
            </div>

            <ul style="list-style: none;">
                <template x-for="task in sprint.tasks" :key="task.id">
                    <li
                        class="group hover:bg-gray-50 transition-colors duration-200 border-b border-gray-100 last:border-0 p-4">
                        <div class="flex items-center justify-between gap-4">

                            <!-- Left Section: Checkbox & Main Info -->
                            <div class="flex items-center gap-4 flex-grow min-w-0">
                                <!-- Checkbox -->
                                <button type="button" @click="toggleTask(task)"
                                    class="flex-shrink-0 w-6 h-6 rounded border transition-all duration-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-primary/50"
                                    :class="task.status === 'completed' ? 'bg-green-500 border-green-500 shadow-sm' : 'border-gray-300 bg-white hover:border-primary'">

                                    <svg x-show="task.status === 'completed'" class="w-4 h-4 text-white" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24" style="display: none;"
                                        x-show.important="task.status === 'completed'">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </button>

                                <!-- Title and Category -->
                                <div class="flex flex-col min-w-0">
                                    <a :href="`/docs/${task.markdown_path}`"
                                        class="text-base font-semibold text-gray-800 hover:text-primary transition-colors truncate block"
                                        :class="{'text-gray-400 line-through': task.status === 'completed'}"
                                        title="Ver documentación" x-text="task.title">
                                    </a>

                                    <div class="mt-2 flex items-center">
                                        <span
                                            class="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-bold uppercase tracking-wider border"
                                            :class="{
                                                'bg-blue-50 text-blue-700 border-blue-100': ['Clase', 'Teoria'].includes(task.category),
                                                'bg-purple-50 text-purple-700 border-purple-100': task.category === 'Practica',
                                                'bg-orange-50 text-orange-700 border-orange-100': task.category === 'Superbadge'
                                            }" x-text="task.category">
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Section: Meta Data -->
                            <div class="flex items-center gap-6 flex-shrink-0">

                                <!-- Date with Icon -->
                                <div class="flex items-center gap-2 text-sm" :class="getDateColorClass(task)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-75" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <span class="font-medium whitespace-nowrap"
                                        x-text="formatDate(task.due_date)"></span>
                                </div>

                                <!-- Status Pill -->
                                <div class="w-24 flex justify-end">
                                    <template x-if="task.status === 'completed'">
                                        <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                                            Completada
                                        </span>
                                    </template>

                                    <template x-if="task.status !== 'completed' && isOverdue(task.due_date)">
                                        <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                                            Atrasado
                                        </span>
                                    </template>

                                    <template x-if="task.status !== 'completed' && !isOverdue(task.due_date)">
                                        <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                                            Pendiente
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </li>
                </template>

                <template x-if="!sprint.tasks || sprint.tasks.length === 0">
                    <li class="text-center py-8 text-gray-500 italic">
                        No hay tareas en este sprint
                    </li>
                </template>
            </ul>
        </div>
    </template>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12 text-gray-500">
        <p>Cargando tu progreso...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function dashboardData() {
        return {
            loading: true,
            sprints: [],
            completedTasks: 0,
            totalTasks: 0,
            overallProgress: 0,
            token: localStorage.getItem('token'),

            async init() {
                if (!this.token) return; // Base layout handles redirect
                await this.fetchData();
                this.loading = false;
            },

            async fetchData() {
                try {
                    // Fetch Sprints and Tasks
                    const sprintsRes = await fetch('/api/curriculum/sprints', {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    const sprintsData = await sprintsRes.json();

                    // Fetch User Progress
                    const progressRes = await fetch('/api/progress/me', {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    const progressData = await progressRes.json();

                    // Merge Progress
                    const progressMap = {};
                    progressData.forEach(p => progressMap[p.task_id] = p.status);

                    this.sprints = sprintsData.map(sprint => ({
                        ...sprint,
                        tasks: sprint.tasks.map(t => ({
                            ...t,
                            status: progressMap[t.id] || 'not_started'
                        }))
                    }));

                    this.calculateStats();

                } catch (e) {
                    console.error('Error loading dashboard data', e);
                }
            },

            calculateStats() {
                let total = 0;
                let completed = 0;

                this.sprints.forEach(sprint => {
                    sprint.tasks.forEach(task => {
                        total++;
                        if (task.status === 'completed') completed++;
                    });
                });

                this.totalTasks = total;
                this.completedTasks = completed;
                this.overallProgress = total > 0 ? Math.round((completed / total) * 100) : 0;
            },

            formatDate(dateString) {
                if (!dateString) return 'Sin fecha';
                try {
                    const date = new Date(dateString);
                    const day = date.getDate();
                    const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
                    const month = months[date.getMonth()];
                    return `${day} ${month}`;
                } catch (e) {
                    console.error(e);
                    return 'Fecha inválida';
                }
            },

            isOverdue(dateString) {
                if (!dateString) return false;
                try {
                    const due = new Date(dateString);
                    const now = new Date();
                    // Reset time to compare only dates (end of due day vs now)
                    due.setHours(23, 59, 59, 999);
                    return now > due;
                } catch (e) {
                    console.error("Date error", e);
                    return false;
                }
            },

            getDateColorClass(task) {
                if (task.status === 'completed') return 'text-green-600';
                if (this.isOverdue(task.due_date)) return 'text-red-600 font-semibold';
                // Check if nearing deadline (within 2 days)
                const due = new Date(task.due_date);
                const now = new Date();
                const diffTime = due - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays <= 2) return 'text-orange-600 font-semibold';

                return 'text-gray-500';
            },

            async toggleTask(task) {
                const newStatus = task.status === 'completed' ? 'not_started' : 'completed';

                // Optimistic update
                task.status = newStatus;
                this.calculateStats();

                try {
                    const res = await fetch('/api/progress/mark', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify({
                            task_id: task.id,
                            status: newStatus
                        })
                    });

                    if (!res.ok) throw new Error('Failed to update');
                } catch (e) {
                    console.error(e);
                    // Revert
                    task.status = newStatus === 'completed' ? 'not_started' : 'completed';
                    this.calculateStats();
                }
            }
        }
    }
</script>

<style>
    /* Progress Bar */
    .progress-bar-container {
        width: 100%;
        height: 0.75rem;
        background: var(--gray-200);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transition: width 0.5s ease-out;
        width: 0%;
        /* Default width */
    }

    /* Specific styles for checked state that are hard to do with classes only */
    input[type="checkbox"].checked-style {
        background-color: var(--green-500) !important;
        border-color: var(--green-500) !important;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }
</style>
{% endblock %}
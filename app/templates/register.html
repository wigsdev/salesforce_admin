{% extends "base.html" %}

{% block title %}Registrarse - Salesforce Admin{% endblock %}

{% block content %}
<div class="container"
    style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
    <div class="form-card" x-data="registerForm()">
        <h1 class="page-title text-center" style="margin-bottom: 2rem;">Crear Cuenta</h1>

        <form @submit.prevent="submitRegister">
            <div class="form-group">
                <label for="name">Nombre Completo</label>
                <input type="text" id="name" x-model="name" required placeholder="Tu nombre">
            </div>

            <div class="form-group">
                <label for="username">Email</label>
                <input type="email" id="username" x-model="email" required placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" x-model="password" required placeholder="Mínimo 8 caracteres">
            </div>

            <div class="form-group">
                <label for="team">Equipo (Opcional)</label>
                <input type="text" id="team" x-model="team" placeholder="Ej: Admin Force">
            </div>

            <button type="submit" class="btn btn-primary btn-full" :disabled="loading"
                x-text="loading ? 'Registrando...' : 'Registrarse'"></button>

            <div x-show="error" class="error-message" x-text="error" style="display: none;"></div>

            <div class="text-center mt-4 text-sm">
                <span style="color: var(--gray-600);">¿Ya tienes cuenta?</span>
                <a href="/login" style="color: var(--primary); font-weight: 600; text-decoration: none;">Inicia
                    sesión</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function registerForm() {
        return {
            name: '',
            email: '',
            password: '',
            team: '',
            loading: false,
            error: '',

            async submitRegister() {
                this.loading = true;
                this.error = '';

                try {
                    // 1. Register
                    const res = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: this.email,
                            password: this.password,
                            name: this.name,
                            team: this.team || 'Sin equipo',
                            role: 'student'
                        })
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        let errorMessage = 'Error al registrarse';
                        if (data.detail) {
                            if (typeof data.detail === 'string') errorMessage = data.detail;
                            else if (Array.isArray(data.detail)) errorMessage = data.detail.map(e => e.msg).join(', ');
                        }
                        throw new Error(errorMessage);
                    }

                    // 2. Auto Login after success
                    await this.autoLogin();

                } catch (e) {
                    this.error = e.message;
                    this.loading = false;
                }
            },

            async autoLogin() {
                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: this.email,
                            password: this.password
                        })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        localStorage.setItem('token', data.access_token);
                        window.location.href = '/';
                    } else {
                        // Fallback if auto-login fails
                        window.location.href = '/login?registered=true';
                    }
                } catch (e) {
                    window.location.href = '/login?registered=true';
                }
            }
        }
    }
</script>
{% endblock %}
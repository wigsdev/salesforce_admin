<!DOCTYPE html>
<html lang="es" x-data="themeData()" :class="{ 'dark': isDark }">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Salesforce Admin Learning Platform{% endblock %}</title>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0F172A',
                            surface: '#1E293B',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <script>
        // Global Toast Helper
        window.showToast = function (message, type = 'success') {
            window.dispatchEvent(new CustomEvent('notify', {
                detail: { id: Date.now() + Math.random(), message, type }
            }));
        };

        function themeData() {
            return {
                isDark: false,
                init() {
                    // Check Local Storage or System Preference
                    if (localStorage.getItem('theme') === 'dark' ||
                        (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        this.isDark = true;
                        document.documentElement.classList.add('dark');
                    } else {
                        this.isDark = false;
                        document.documentElement.classList.remove('dark');
                    }
                },
                toggleTheme() {
                    this.isDark = !this.isDark;
                    if (this.isDark) {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                    }
                }
            }
        }

        function authData() {
            return {
                user: null,
                token: localStorage.getItem('token'),

                async init() {
                    if (this.token) {
                        await this.fetchUser();
                    } else {
                        // Check if current page requires auth
                        const publicPages = ['/login', '/register'];
                        if (!publicPages.includes(window.location.pathname)) {
                            window.location.href = '/login';
                        }
                    }
                },

                async fetchUser() {
                    try {
                        const res = await fetch('/api/users/me', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        if (res.ok) {
                            this.user = await res.json();
                        } else {
                            this.logout();
                        }
                    } catch (e) {
                        console.error('Auth error', e);
                    }
                },

                logout() {
                    localStorage.removeItem('token');
                    this.user = null;
                    this.token = null;
                    window.location.href = '/login';
                }
            }
        }
    </script>

    <!-- Global Styles -->
    <link rel="stylesheet" href="/static/css/styles.css?v=3.1">

    {% block head %}{% endblock %}
</head>

<body x-data="authData()"
    class="bg-gray-50 text-gray-900 dark:bg-dark-bg dark:text-gray-100 transition-colors duration-300">

    <!-- Navigation -->
    <!-- Navigation -->
    <header class="nav-header dark:bg-dark-surface dark:border-dark-border" style="padding: 0 !important;"
        x-data="{ mobileMenuOpen: false }">
        <div class="container mx-auto flex justify-between items-center h-12 relative">
            <!-- Brand -->
            <a href="/" class="nav-brand dark:text-white flex items-center">
                <span class="hidden md:block">Admin Salesforce Learning</span>
                <span
                    class="md:hidden flex items-center justify-center w-8 h-8 rounded bg-primary text-white font-bold">AS</span>
            </a>

            <!-- Desktop Menu -->
            <nav class="hidden md:flex items-center gap-4">
                <!-- Theme Toggle -->
                <button @click="toggleTheme()"
                    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors flex items-center justify-center">
                    <svg x-show="!isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <svg x-show="isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="display: none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401">
                        </path>
                    </svg>
                </button>

                <template x-if="user">
                    <div class="flex items-center gap-4">
                        <a href="/" class="nav-link dark:text-gray-300 dark:hover:text-white">Dashboard</a>
                        <a href="/lumina/dashboard"
                            class="nav-link text-emerald-600 dark:text-emerald-400 font-medium hover:text-emerald-700 dark:hover:text-emerald-300">Lumina
                            üèõÔ∏è</a>
                        <a href="/docs/browse"
                            class="nav-link dark:text-gray-300 dark:hover:text-white">Documentaci√≥n</a>

                        <div
                            class="flex items-center gap-3 ml-4 bg-gray-50 dark:bg-gray-800 px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700">
                            <span x-text="user.name" class="font-bold text-sm text-gray-700 dark:text-gray-200"></span>
                            <button @click="logout"
                                class="text-sm text-red hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium">Salir</button>
                        </div>
                    </div>
                </template>

                <template x-if="!user">
                    <div class="flex items-center gap-4">
                        <a href="/login" class="nav-link dark:text-gray-300 dark:hover:text-white">Login</a>
                        <a href="/register" class="btn btn-primary text-sm py-2">Registrarse</a>
                    </div>
                </template>
            </nav>

            <!-- Mobile Menu Controls -->
            <div class="md:hidden flex items-center gap-2">
                <!-- Mobile Theme Toggle -->
                <button @click="toggleTheme()"
                    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors flex items-center justify-center">
                    <svg x-show="!isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <svg x-show="isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        style="display: none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401">
                        </path>
                    </svg>
                </button>

                <!-- Mobile Menu Button -->
                <button @click="mobileMenuOpen = !mobileMenuOpen"
                    class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-colors">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <!-- Hamburger Icon -->
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <!-- Trello-style Dropdown Menu (Now direct child of container) -->
            <div x-show="mobileMenuOpen" @click.away="mobileMenuOpen = false"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75"
                x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                style="display: none;"
                class="absolute top-full right-4 w-64 rounded-xl bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden transform origin-top-right">

                <template x-if="user">
                    <div class="py-2">
                        <div class="px-4 py-2 border-b border-gray-100 dark:border-gray-700">
                            <p class="text-sm font-medium text-gray-900 dark:text-white" x-text="user.name"></p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Administrador</p>
                        </div>

                        <a href="/"
                            class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Dashboard
                        </a>
                        <a href="/docs/browse"
                            class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Documentaci√≥n
                        </a>
                        <a href="/lumina/dashboard"
                            class="block px-4 py-2 text-sm text-emerald-600 dark:text-emerald-400 font-medium hover:bg-emerald-50 dark:hover:bg-emerald-900/20">
                            Lumina Project üèõÔ∏è
                        </a>

                        <div class="border-t border-gray-100 dark:border-gray-700 mt-2 pt-2">
                            <button @click="logout"
                                class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                                Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                </template>

                <template x-if="!user">
                    <div class="p-2 space-y-2">
                        <a href="/login"
                            class="block px-4 py-2 text-sm text-center text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
                            Login
                        </a>
                        <a href="/register"
                            class="block px-4 py-2 text-sm text-center text-white bg-primary hover:bg-primary-dark rounded-lg">
                            Registrarse
                        </a>
                    </div>
                </template>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="text-center py-8 text-gray-500 text-sm">
        <p>¬© 2026 Admin Salesforce Learning Platform. MVP v0.30.0</p>
    </footer>

    <!-- Notifications Container -->
    <div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none" x-data="{ notifications: [] }"
        @notify.window="notifications.push($event.detail); setTimeout(() => { notifications = notifications.filter(n => n.id !== $event.detail.id) }, 3000)">
        <template x-for="note in notifications" :key="note.id">
            <div class="pointer-events-auto px-4 py-3 rounded-lg shadow-lg text-white font-medium text-sm flex items-center gap-2 min-w-[300px] transform transition-all duration-300"
                :class="{
                    'bg-green-600': note.type === 'success',
                    'bg-red-600': note.type === 'error',
                    'bg-blue-600': note.type === 'info'
                 }" x-transition:enter="translate-y-2 opacity-0" x-transition:enter-end="translate-y-0 opacity-100"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-end="opacity-0 translate-x-2">

                <!-- Icons -->
                <svg x-show="note.type === 'success'" class="w-5 h-5" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <svg x-show="note.type === 'error'" class="w-5 h-5" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>

                <span x-text="note.message"></span>
            </div>
        </template>
    </div>

    <!-- Global Auth Logic & Helpers -->


    {% block scripts %}{% endblock %}
</body>

</html>
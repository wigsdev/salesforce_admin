{% extends "base.html" %}

{% block title %}Iniciar Sesión - Salesforce Admin{% endblock %}

{% block content %}
<div class="container"
    style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
    <div class="form-card" x-data="loginForm()">
        <h1 class="page-title text-center" style="margin-bottom: 2rem;">Acceder</h1>

        <form @submit.prevent="submitLogin">
            <div class="form-group">
                <label for="username">Email</label>
                <input type="email" id="username" x-model="username" required placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" x-model="password" required placeholder="••••••••">
            </div>

            <button type="submit" class="btn btn-primary btn-full" :disabled="loading"
                x-text="loading ? 'Entrando...' : 'Entrar'"></button>

            <div x-show="error" class="error-message" x-text="error" style="display: none;"></div>

            <div class="text-center mt-4 text-sm">
                <span style="color: var(--gray-600);">¿No tienes cuenta?</span>
                <a href="/register" style="color: var(--primary); font-weight: 600; text-decoration: none;">Regístrate
                    aquí</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function loginForm() {
        return {
            username: '',
            password: '',
            loading: false,
            error: '',

            async submitLogin() {
                this.loading = true;
                this.error = '';

                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: this.username,
                            password: this.password
                        })
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        let errorMessage = 'Error al iniciar sesión';
                        if (data.detail) {
                            if (typeof data.detail === 'string') errorMessage = data.detail;
                            else if (Array.isArray(data.detail)) errorMessage = data.detail.map(e => e.msg).join(', ');
                        }
                        throw new Error(errorMessage);
                    }

                    localStorage.setItem('token', data.access_token);
                    window.location.href = '/';

                } catch (e) {
                    this.error = e.message;
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Comando Lumina Tech - Roadmap Project{% endblock %}

{% block content %}
<div class="container mx-auto px-8 py-8" x-data="projectManager()">

    <!-- HEADER & CONTROLS -->
    <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <span
                    class="bg-blue-100 text-[#005A9C] px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Sprint
                    1</span>
            </div>
            <h1 class="text-3xl font-black text-gray-900 dark:text-white tracking-tight">Lumina Tech <span
                    class="text-[#005A9C]">Daily Check</span> üèõÔ∏è</h1>
        </div>

        <!-- DYNAMIC DAY SELECTOR & MANAGEMENT -->
        <div class="w-full md:w-auto flex items-center gap-2">
            <div class="relative flex-1 md:w-80">
                <select id="daySelect" x-model.number="selectedDayId"
                    class="block w-full pl-4 pr-12 py-3 text-base border-gray-300 focus:outline-none focus:ring-[#005A9C] focus:border-[#005A9C] sm:text-sm rounded-xl shadow-sm dark:bg-dark-surface dark:border-dark-border dark:text-white appearance-none bg-no-repeat bg-right">
                    <template x-for="day in days" :key="day.id">
                        <option :value="day.id" x-text="day.title"></option>
                    </template>
                </select>
                <!-- Custom Arrow -->
                <div
                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-700 dark:text-gray-300">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- ADD NEW DAY BUTTON -->
            <button @click="createNewDay()" title="Crear Nuevo D√≠a"
                class="p-3 bg-[#005A9C] hover:bg-blue-700 text-white rounded-xl shadow-sm transition-colors flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>

            <!-- DELETE DAY BUTTON -->
            <button @click="deleteCurrentDay()" title="Eliminar D√≠a Actual" x-show="days.length > 1"
                class="p-3 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl shadow-sm transition-colors flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <!-- MAIN TASK BOARD -->
    <template x-if="currentDay">
        <div
            class="bg-white dark:bg-dark-surface rounded-lg shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden min-h-[500px] flex flex-col">

            <!-- EDITABLE HEADER (Distinct Darker Block) -->
            <div
                class="p-6 bg-gradient-to-r from-gray-50 to-white dark:from-dark-surface dark:to-dark-bg border-b border-gray-200 dark:border-dark-border flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex-1 w-full">
                    <!-- Title Input (Standardized) -->
                    <input type="text" x-model="currentDay.title" @input.debounce.500ms="updateDayTitle()"
                        class="w-full !bg-transparent !border-none !p-0 text-xl font-bold text-gray-900 dark:text-white focus:ring-0 placeholder-gray-500 !shadow-none ring-0"
                        placeholder="Nombre del D√≠a">
                    <!-- Reference Input (Subtitle) -->
                    <input type="text" x-model="currentDay.reference" @input.debounce.500ms="updateDayRef()"
                        class="w-full !bg-transparent !border-none !p-0 mt-1 text-sm text-gray-500 dark:text-gray-400 focus:ring-0 placeholder-gray-500 !shadow-none ring-0"
                        placeholder="Referencia">
                </div>

                <!-- Day Status -->
                <div x-show="isDayComplete()" x-transition
                    class="flex items-center gap-2 bg-green-900/30 text-green-400 px-3 py-1 rounded-full border border-green-800 text-xs font-bold uppercase tracking-wide">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Completado</span>
                </div>
            </div>

            <!-- TASK LIST BODY -->
            <ul class="flex-col">
                <template x-for="(task, index) in currentDay.tasks" :key="task.id">
                    <li
                        class="group flex items-center justify-between gap-4 p-4 border-b border-gray-100 dark:border-dark-border last:border-0 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors duration-200">

                        <div class="flex items-center gap-4 flex-1">
                            <!-- Checkbox -->
                            <button type="button" @click="toggleTask(index)"
                                class="flex-shrink-0 w-6 h-6 rounded border transition-all duration-200 flex items-center justify-center focus:outline-none"
                                :class="task.done ? 'bg-green-600 border-green-600 shadow-sm' : 'border-gray-500 bg-transparent hover:border-blue-500'">

                                <svg x-show="task.done" class="w-4 h-4 text-white" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>

                            <!-- Editable Text -->
                            <input type="text" x-model="task.desc"
                                class="flex-1 !bg-transparent !border-none !p-0 text-base font-normal text-gray-800 dark:text-gray-200 focus:ring-0 !shadow-none"
                                :class="task.done ? 'line-through text-gray-500' : ''">
                        </div>

                        <!-- Right Actions: Badge & Delete -->
                        <div class="flex items-center gap-4 pl-4">
                            <!-- Status Badge -->
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border whitespace-nowrap"
                                :class="task.done ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200'">
                                <span x-text="task.done ? 'Completado' : 'Atrasado'"></span>
                                <!-- Using 'Atrasado' style for pending as per user request/image -->
                            </span>

                            <!-- Delete Button -->
                            <button @click="deleteTask(index)"
                                class="p-2 text-gray-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 flex-shrink-0"
                                title="Eliminar Tarea">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </li>
                </template>
            </ul>

            <!-- Empty State -->
            <div x-show="currentDay.tasks.length === 0" class="text-center py-10 text-gray-400">
                <p>Este d√≠a a√∫n no tiene tareas. ¬°A√±ade la primera!</p>
            </div>

            <!-- ADD TASK INPUT (Footer Style) -->
            <div class="p-4 bg-gray-50 dark:bg-gray-800/20 border-t border-gray-100 dark:border-dark-border">
                <div class="flex items-center gap-3">
                    <div
                        class="flex-shrink-0 w-6 h-6 rounded-md border-2 border-gray-300 border-dashed flex items-center justify-center text-gray-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                    </div>
                    <input type="text" x-model="newTaskText" @keydown.enter="addTask()"
                        placeholder="A√±adir una tarea..."
                        class="flex-1 bg-transparent border-none focus:ring-0 text-gray-600 dark:text-gray-300 placeholder-gray-400">
                    <button @click="addTask()" :disabled="!newTaskText"
                        class="text-sm font-bold text-[#005A9C] disabled:opacity-50 disabled:cursor-not-allowed hover:underline">
                        A√ëADIR
                    </button>
                </div>
            </div>

        </div>
    </template>
</div>

<script>
    function projectManager() {
        return {
            days: [],
            selectedDayId: null,
            newTaskText: '',
            loading: false,

            async init() {
                await this.fetchData();
            },

            async fetchData() {
                try {
                    const res = await fetch('/api/lumina/days');
                    if (res.ok) {
                        const data = await res.json();
                        this.days = Array.isArray(data) ? data : [];
                    } else {
                        console.error("Failed to fetch days:", res.status);
                        this.days = [];
                    }

                    // Select first day if none selected or invalid
                    if (this.days.length > 0) {
                        if (!this.selectedDayId || !this.days.find(d => d.id === this.selectedDayId)) {
                            this.selectedDayId = this.days[0].id; // Select the first day by default
                        }
                    } else {
                        this.selectedDayId = null;
                    }
                } catch (e) {
                    console.error("Error loading days", e);
                    this.days = []; // Ensure it's an array on error
                }
            },

            get currentDay() {
                return this.days.find(d => d.id === this.selectedDayId);
            },

            async createNewDay() {
                const dayCount = this.days.length + 1;
                const newTitle = `üìù D√çA ${dayCount}: Nuevo D√≠a`;
                const newRef = "Sin referencia";

                try {
                    const res = await fetch('/api/lumina/days', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: newTitle, reference: newRef })
                    });

                    const newDay = await res.json();
                    this.days.push(newDay);
                    this.selectedDayId = newDay.id;
                } catch (e) {
                    console.error("Error creating day", e);
                    alert("Error al crear el d√≠a");
                }
            },

            async deleteCurrentDay() {
                if (!this.currentDay) return;

                if (confirm('¬øEst√°s seguro de eliminar este d√≠a completo y sus tareas?')) {
                    const idToDelete = this.selectedDayId;
                    try {
                        const res = await fetch(`/api/lumina/days/${idToDelete}`, { method: 'DELETE' });
                        if (res.ok) {
                            const idx = this.days.findIndex(d => d.id === this.selectedDayId);
                            this.days.splice(idx, 1);
                            // Select previous or first day
                            if (this.days.length > 0) {
                                this.selectedDayId = this.days[Math.max(0, idx - 1)].id;
                            } else {
                                this.selectedDayId = null;
                            }
                        }
                    } catch (e) {
                        console.error("Error deleting day", e);
                    }
                }
            },

            async addTask() {
                if (!this.newTaskText.trim()) return;
                if (!this.currentDay) return;

                const text = this.newTaskText;
                this.newTaskText = ''; // Clear input immediately

                try {
                    const res = await fetch(`/api/lumina/days/${this.selectedDayId}/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ description: text })
                    });
                    const newTask = await res.json();
                    this.currentDay.tasks.push(newTask);
                } catch (e) {
                    console.error("Error adding task", e);
                    alert("Error al agregar tarea");
                }
            },

            async toggleTask(index) {
                const task = this.currentDay.tasks[index];
                // Optimistic toggle
                task.done = !task.done;

                try {
                    const res = await fetch(`/api/lumina/tasks/${task.id}/toggle`, { method: 'PUT' });
                    if (!res.ok) {
                        // Revert on error
                        task.done = !task.done;
                    }
                } catch (e) {
                    console.error("Error toggling task", e);
                    task.done = !task.done;
                }
            },

            async deleteTask(index) {
                const task = this.currentDay.tasks[index];
                if (!confirm("¬øEliminar tarea?")) return;

                try {
                    const res = await fetch(`/api/lumina/tasks/${task.id}`, { method: 'DELETE' });
                    if (res.ok) {
                        this.currentDay.tasks.splice(index, 1);
                    }
                } catch (e) {
                    console.error("Error deleting task", e);
                }
            },

            async updateDayTitle() {
                if (!this.currentDay) return;
                try {
                    await fetch(`/api/lumina/days/${this.currentDay.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: this.currentDay.title })
                    });
                } catch (e) { console.error(e); }
            },

            async updateDayRef() {
                if (!this.currentDay) return;
                try {
                    await fetch(`/api/lumina/days/${this.currentDay.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reference: this.currentDay.reference })
                    });
                } catch (e) { console.error(e); }
            },

            isDayComplete() {
                if (!this.currentDay || this.currentDay.tasks.length === 0) return false;
                return this.currentDay.tasks.every(t => t.done);
            }
        }
    }
</script>
{% endblock %}